# 関係スキーマ

## 関数従属性
- 「項目Xが決定すると、項目Yの値が一意に決定される」
- この時、項目Yは項目Xに従属しているといい、Xを決定項、Yを被決定項という
- イメージとしては、「”→”の元が1つ決まれば、"→"の先も一つに決まる」
  - A → B : Aが決まれば、Bが決まる
  - {A, B} → C : A, Bが決まればCが決まる
  - C → {A, B} : Cが決まれば、 AもBも決まる(C→A, C→B)
- 例
  - 会員番号は、受講生に割り振られた一位な番号である
    - 会員番号 → 受講生の属性
  - 課題番号は、各講座ごとに定められている課題の連番
    - {講座名, 課題番号} → {課題の属性}
  - 同じ受講者(会員)は同じ講座を2度と申し込むことはできない
    - 受講番号 → {会員番号, 講座名}
  - 受講生の受講番号ごと、課題番号ごとに事前に担当の指導者を割り振る
    - {受講番号, 課題番号} → 指導者

## キー
- 主キー
  - 関係(もしくは表)の中に1つだけ設定するキー
  - 一意性制約と非NULLを合わせ持つ
  - **候補キーの中から最も相応しいものを選ぶ**
- 候補キー
  - 関係(もしくは表)の中に複数存在することもあるキー
  - 主キーの候補となるキーのこと
  - 候補キーの条件は次の2つ
    - タプル(行・レコード)を1つに特定できる
    - 極小であること(スーパーキーの中で極小のもの)
  - **主キーとは異なり、NULLを許可する属性を持つ(または含む)でも可**
- スーパーキー
  - 関係(もしくは表)の中に候補キーの数以上に存在するのがスーパーキー
  - **タプル(行・レコード)を1つに特定できる組み合わせであればなんでもよく、不要な属性が含まれていてもいい**
    - 候補キーに様々な組み合わせの他属性を付け足したものになる
- 主キー(表に一つ、NULLはNG) < 候補キー(表に複数存在することもある、NULLもOK) < スーパーキー(表にたくさん)

### 例題
---------------------------------------------------------------------

|社員番号|連番|氏名|性別|電話番号|住所|
|-|-|-|-|-|-|
|0001|01|三好康之|男性|072-xxx-xxxx|兵庫県...|
|0001|02|三好康之|男性|090-yyy-yyyy|兵庫県...|
|0002|01|松田幹子|女性|03-zzz-zzzz|NULL|
|0003|01|山下真吾|男性|090-wwww-wwww|東京都渋谷区...|
|0003|02|山下真吾|男性|NULL|神奈川県...|

- スーパーキー
  - {社員番号, 連番}, {社員番号, 連番, 氏名}, {社員番号, 連番, 氏名, 性別}...
{社員番号, 連番, 住所}, {社員番号, 連番, 電話番号, 住所}, ...
  - 大量にあるので、正直あまり意味はないし、実務上で使われることはない(あくまで理論上)
  - 問題で候補キーを問われた時も、別にスーパーキーは考えずどの組み合わせなら一意になるか？を考えればいい(= 候補キーを考える)。あくまで理論上のもの。
- 候補キー
  - {社員番号, 連番},{社員番号, 電話番号, 住所}
  - どの組み合わせで一意になるか考える
- 主キー
  - {社員番号, 連番}
    - 候補キーのうち、電話番号と住所にはNULLを許容しているので主キーになれない

---------------------------------------------------------------------

- サロゲートキー(代替キー、代用キー、代理キー)
  - エンティティが本来持つ属性からなる主キーは"ナチュラルキー"と呼ばれる
  - ナチュラルキーの代わりとして付与されるキーのことをサロゲートキーといい、"連番"に代表されるようにその値自体には意味はなく、一意性を確保して主キーとして使うためだけに付与される。
  - 具体的には
    - 主キーが複合キーの場合
      - 複合キーを扱いやすくしたいときに置き換える
      - 例えば、many_to_manyの中間テーブルで、そのレコード自体にIDをサロゲートで与えると、そのレコードに対してはそのサロゲートIDで引っ張れる
    - データウェアハウスで長期間の履歴を管理したい場合
      - 例えば、社員IDが長期間で見ると違う人になることがある場合など
- 外部キー
  - 他のリレーションの主キー(または候補キーでも良い)を参照する項目を外部キーという

## 試験メモ
### 候補キーをすべて列挙する問題の考え方
- パターン1：関数従属性を示す図を使って解答するパターン(頻出)
  - 前提として、関数従属性はある1つのテーブルに幾つかの属性があって、その属性間の関係について表現したもの。つまり、テーブル間ではなく、テーブル内のカラムの関係性を示している。
  - 手順1：すべての「→」の始点をピックアップする
    - この時、全ての矢印に番号をふる(①, ②, ...)
    - **この始点が候補キーの候補となる**
    - 例
      - ①②③④⑤の矢印の始点:A.{入院日, 患者番号}
      - ⑥の矢印の始点: B.{患者番号, 診察科}
      - ⑦⑧の矢印の始点:C.{入院日, 患者番号}
  - 手順2：候補キーの3つのキー(A, B, C)が全ての属性を一意に決めれるか順番にチェックしていく
    - **何らかの属性を経由してでも全ての属性に矢印が伸ばせるのであれば候補キーである**
    - 一方、どの属性を経由しても全ての属性にアクセスできない場合は、候補キーではない
  - 手順3：**ある属性から候補キーに対して、「→」「←」の両方の矢印が伸びている場合、その属性も候補キーの一部とみなすことができるため、置換えが発生する。**
- パターン2：関数従属性を示す図を使わずに解答するパターン

### 主キーや外部キーを示す設問