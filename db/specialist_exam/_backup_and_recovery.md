# バックアップとリカバリ

# バックアップ
## 1. 全体パックアップ
- 対象データをすべてバックアップする
- メリット
  - 障害時には直近取得した全体バックアップから復元するだけなので短時間で復旧できる
- デメリット
  - バックアップに時間がかかる

## 2. 差分バックアップ
- 最新の全体バックアップからの変更箇所だけを対象とする方法
- メリット
  - 前回の全体バックアップからの差分のみをバックアップするため、バックアップに要する時間は小さくなる
- デメリット
  - 復元時に前回の全体バックアップをまず戻し、そこに”直近の差分バックアップ”をさらに戻す必要がある
    - 差分バックアップでは、バックアップファイル自体が1つで、それを更新していくスタイル。
    - 例えば、日曜に障害があれば "フルバックアップファイル+月から土曜までのバックアップをまとめた1ファイル"を使う

## 3. 増分バックアップ
- 前回のバックアップ取得時からの更新箇所だけを対象とする方法
- 差分バックアップとの違いは、**前回の増分バックアップ以降に更新された箇所もバックアップする点**
  - 
- メリット
  - 前日からの更新箇所のみバックアップになるため、バックアップに要する時間が最も短い
- デメリット
  - 復元時に全体バックアップファイルと、各日のバックアップファイルを全て使用するので、最も復旧に時間がかかる
    - 例えば、日曜に障害があれば "フルバックアップファイル+月から土曜までの各日に作ったバックアップファイル6つ"を使う

## 参考例
- ケース1. 在庫テーブルは、在庫のうち３割(売れ筋商品)に相当する約1000行が毎日頻繁に更新される
  - 差分バックアップを選択する
  - 理由
    - 日々のバックアップ取得時間は差分でも増分でも1000行分
    - ファイル容量
      - 差分：常に最新の差分で上書きするので1000行
      - 増分：バックアップのファイル数が(日数×1000行)
    - 復旧時間
      - 差分：1000行分の復元なので速い
      - 増分：日にち順(日数×1000行分)で復元するので遅い
    
- ケース2. 出荷テーブルには毎日約400,000行が追加される
  - 増分バックアップを選択する
  - 理由
    - 日々のバックアップ対象ファイル数が異なる。復元時間はほぼ変わらない。
  - ファイル容量
    - 差分：全体バックアップから変化があったファイルを毎日対象にするので、1日目に400,000件なら2日目には800,000件と増える。(日数×400,000行)
    - 増分：毎日変化のあったファイルの分だけ対象にするので、400,000行のまま固定

## イメージ
- 差分：最終フルバックアップから変化のあったファイルの最新状態だけを毎日更新して保持している。途中の状態は分からん。
- 増分：前回の増分バックアップから変化のあったファイルだけを対象に更新履歴をとる。更新履歴を全て合わせると復元できる。

# リカバリ
- ロールバック
  - 要するにある地点までDBの状態を元に戻したい
  - **ログ更新前のイメージを新しいものから順に適用**して、特定の時点まで戻す。
  - 例えば、あるトランザクションでエラーが起こったらロールバックしてデータの整合性を正しくする
- ロールフォワード
  - 要するにある地点までDBの状態を前に進めたい
  - **ログ更新後のイメージを古いものから順に適用**して、特定の時点まで進める。
  - 例えば、あるタイミングでハードディスクが故障した時に、最新のチェックポイントまで戻したあと、ログファイルを使ってできるだけ最新の状態まで復元する。

## WAL:Write Ahead Loading
- ログファイルには、データベースに対して行った全ての操作の履歴を記録しておく。処理の種類、更新時刻、更新前イメージ、更新後イメージなど。
- ログを先書きするプロトコル(WAL)の場合、次の順番になる。
  - 更新前イメージのログファイル書き出し
  - **更新後イメージのログファイル書き出し（←ポイント！！）**
  - データベース更新
  - コミット

## コミットとチェックポイント
- コミット
  - トランザクションの処理結果を確定して、ログファイルにトランザクション完了の記録を書き出すこと
  - コミットの処理後、稼働中のDBMS内で整合性が取れている
- チェックポイント
  - 稼働中のDBMSで管理しているデータと2次記憶上のデータベースの内容との同期をとるタイミング

## ディザスタリカバリ
- RTO(Recovery Time Objective)
  - 災害等によってシステムに障害が発生し、使用できなくなってから再び使用できるようになるまでの時間。許容停止時間。
- RPO(Recovery Point Objective)
  - システムが再稼働した時にデータが災害発生前のどの時点まで復旧させなければならないかを示す指標。